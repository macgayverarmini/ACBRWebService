# =========================================================================
# DOCKERFILE DE TESTE - Para testar builds multi-plataforma
# =========================================================================
FROM ubuntu:22.04

# Evita que a instalação peça interação do usuário
ENV DEBIAN_FRONTEND=noninteractive

# Instala dependências de sistema essenciais (incluindo suporte para 32 bits)
RUN apt-get update && \
    # Adiciona arquitetura i386 para suporte a 32 bits
    dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    git \
    subversion \
    python3 \
    python3-pip \
    dos2unix \
    wget \
    unzip \
    binutils-mingw-w64 \
    libgtk2.0-dev \
    gcc-multilib \
    libgtk2.0-dev:i386 && \
    rm -rf /var/lib/apt/lists/*

# Link simbólico para o windres
RUN ln -s /usr/bin/x86_64-w64-mingw32-windres /usr/bin/windres

# Baixa e instala fpclazup
RUN wget https://github.com/LongDirtyAnimAlf/Reiniero-fpcup/releases/download/v2.4.0f/fpclazup-x86_64-linux -O /usr/local/bin/fpclazup && \
    chmod +x /usr/local/bin/fpclazup

# Instala FPC e Lazarus
RUN fpclazup --noconfirm --lazversion=3.6 --fpcversion=3.2.2 --installdir=/root/development

# Adiciona as ferramentas do Lazarus ao PATH
ENV PATH="/root/development/lazarus:$PATH"

# Define o diretório de trabalho
WORKDIR /app

# Copia todos os arquivos do projeto
COPY . .

# Garante permissões e formato corretos
RUN dos2unix ./download.sh ./build.sh && chmod +x ./download.sh ./build.sh

# Baixa as dependências do projeto
RUN ./download.sh

# Instala dependências Python
RUN pip3 install tqdm

# Define argumentos de build para a plataforma alvo
ARG TARGET_OS=linux
ARG TARGET_CPU=x86_64

# Executa o script de build com os parâmetros especificados
RUN ./build.sh --os=${TARGET_OS} --cpu=${TARGET_CPU}

# Lista os arquivos gerados para debug
RUN echo "=== ARQUIVOS GERADOS ===" && \
    find /app -name "ACBRWebService*" -type f 2>/dev/null || echo "Nenhum executável encontrado" && \
    echo "=== CONTEÚDO DO DIRETÓRIO /app ===" && \
    ls -la /app && \
    echo "=== CONTEÚDO DO DIRETÓRIO /app/bin ===" && \
    ls -la /app/bin 2>/dev/null || echo "Diretório bin não existe"

# Comando padrão para manter o container rodando
CMD ["bash"]