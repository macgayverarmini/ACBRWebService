name: Lazarus CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout do código do projeto
      uses: actions/checkout@v4
      with:
        path: 'project'

    - name: Configurar Lazarus e FPC
      uses: gcarreno/setup-lazarus@v3
      with:
        lazarus-version: '2.2.0'

    - name: Checkout das dependências
      run: |
        git clone https://github.com/ProjetoACBr/ACBr.git ../acbr
        git clone https://github.com/HashLoad/horse.git ../horse-master
        git clone https://github.com/HashLoad/handle-exception.git ../handle-exception
        git clone https://github.com/HashLoad/jhonson.git ../jhonson
        git clone https://github.com/fortesreport/fortesreport-ce.git ../fortesreport-ce

    - name: Compilar pacotes de dependência
      run: |
        lazbuild -B ../fortesreport-ce/packages/lazarus/frce.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_Comum.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_OpenSSL.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_PCN.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_DFe_Comum.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_NFe.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_NFe_DanfeRL.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_CTe.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_CTe_DACTeRL.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_MDFe.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_MDFe_DAMDFeRL.lpk

    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Instalar dependências Python
      run: pip install tqdm
      
    - name: Executar script de alteração do ACBr
      run: |
        cd project
        yes s | python script_altera_acbr.py ../acbr/Fontes/ACBrDFe/
      
    - name: Compilar o projeto para Linux
      run: |
        cd project
        lazbuild -B ACBRWebService.lpi

    - name: Upload do executável de Linux (Artefato)
      uses: actions/upload-artifact@v4
      with:
        name: ACBRWebService-Linux
        path: project/bin/ACBRWebService

  build-windows:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout do código do projeto
      uses: actions/checkout@v4
      with:
        path: 'project'

    - name: Configurar Lazarus, FPC e o Cross-Compiler
      uses: gcarreno/setup-lazarus@v3
      with:
        lazarus-version: '2.2.0'
        with-cross-bits: '64'
        with-cross-os: 'win'

    - name: Checkout das dependências
      run: |
        git clone https://github.com/ProjetoACBr/ACBr.git ../acbr
        git clone https://github.com/HashLoad/horse.git ../horse-master
        git clone https://github.com/HashLoad/handle-exception.git ../handle-exception
        git clone https://github.com/HashLoad/jhonson.git ../jhonson
        git clone https://github.com/fortesinformatica/fortesreport-ce.git ../fortesreport-ce4
    
    - name: Compilar pacotes de dependência
      run: |
        lazbuild -B ../fortesreport-ce4/Packages/frce.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBrComum.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBrOpenSSL.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBrPCN.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBrDFeComum.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_NFe.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_NFe_DanfeRL.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_CTe.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_CTe_DACTeRL.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_MDFe.lpk
        lazbuild -B ../acbr/Pacotes/Lazarus/ACBr_MDFe_DAMDFeRL.lpk

    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Instalar dependências Python
      run: pip install tqdm
      
    - name: Executar script de alteração do ACBr
      run: |
        cd project
        yes s | python script_altera_acbr.py ../acbr/Fontes/ACBrDFe/
      
    - name: Compilar o projeto para Windows 64-bit
      run: |
        cd project
        lazbuild -B --os=win64 --cpu=x86_64 ACBRWebService.lpi

    - name: Upload do executável de Windows (Artefato)
      uses: actions/upload-artifact@v4
      with:
        name: ACBRWebService-Win64
        path: project/bin/ACBRWebService.exe
